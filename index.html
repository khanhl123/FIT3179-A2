<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>How Australians got to work?</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Typography & layout -->
  <style>
    :root{
      --bg:#f7f9fc; --ink:#0f172a; --muted:#64748b; --panel:#fff; --stroke:#e5e7eb;
      --card-shadow:0 4px 18px rgba(15,23,42,.06);
      --brand:#0f172a; --accent:#2563eb;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;line-height:1.6}
    header{padding:36px 20px 12px;text-align:center}
    h1{margin:0;font-weight:800;letter-spacing:-0.02em;font-size:clamp(36px,4.5vw,44px)}
    .subtitle{margin-top:8px;color:#94a3b8;font-size:13px;text-transform:uppercase;letter-spacing:.12em}
    .intro{max-width:920px;margin:12px auto 0;color:#334155;font-size:16.5px}
    .wrap{max-width:1200px;margin:0 auto;padding:0 16px 48px}
    .grid{display:grid;grid-template-columns:1fr;gap:24px}

    /* Cards */
    .card{background:var(--panel);border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--card-shadow)}
    .pad{padding:20px}
    .card h2{font-size:clamp(24px,2.5vw,28px);margin:0 0 12px;font-weight:800}
    .muted{color:var(--muted);font-size:13px}
    .loading{margin-top:8px;color:var(--muted);font-size:13px}
    .card-footer{margin-top:10px;border-top:1px dashed #e2e8f0;padding-top:8px;font-size:13px;color:#475569}
    .card-footer a{color:var(--accent);text-decoration:none}

    /* Two-column helpers */
    .map-grid{display:grid;gap:16px;align-items:start}
    .map-grid--notes-left{grid-template-columns:360px minmax(420px,1fr)}
    .side-notes{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:12px 14px;color:#334155;font-size:15px}
    .side-notes h3{margin:0 0 8px;font-size:17px}
    .two-grid{display:grid;grid-template-columns:minmax(320px,1fr) minmax(320px,1fr);gap:16px;align-items:start}
    @media (max-width: 900px){ .map-grid--notes-left,.two-grid{grid-template-columns:1fr} }

    /* AUS map controls */
    .metric-toggle{display:flex;gap:10px;align-items:center;margin:8px 0 10px}
    .metric-toggle .seg{display:inline-flex;border:1px solid #dbe3ef;border-radius:10px;overflow:hidden}
    .metric-toggle input{position:absolute;opacity:0;pointer-events:none}
    .metric-toggle label{padding:6px 12px;cursor:pointer;background:#fff;color:#334155}
    .metric-toggle input:checked + label{background:#0f172a;color:#fff}

    /* Melbourne dot map */
    #mapBox{height:620px; position:relative;}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:6px 0 10px}
    select,button,label{font:inherit}
    .btn{padding:6px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer}
    .btn.active{background:#0f172a;color:#fff;border-color:#0f172a}
    .tooltip{position:absolute;pointer-events:none;background:#111827;color:#fff;padding:8px 10px;border-radius:10px;font-size:12px;box-shadow:0 6px 18px rgba(0,0,0,.2)}
    svg{display:block;width:100%;height:100%}
    .label{font-size:10px;fill:#111827;paint-order:stroke;stroke:#fff;stroke-width:3px;stroke-linejoin:round}
    .legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .legend-title{font-size:12.5px;color:#475569;font-weight:600;margin-right:8px}
    .sw{width:14px;height:14px;border-radius:3px;border:1px solid #e2e8f0;display:inline-block}
    #slopeChart{min-height:420px;}

    /* Vega-Lite radio bindings (unused now, but keep for consistency) */
    .vega-embed{background:#fff;border-radius:16px;}
    #ausMap .vega-bindings{display:none}

    footer.site{margin:24px auto 40px;max-width:1200px;padding:0 16px;color:#475569;font-size:14px}
    footer.site a{color:var(--accent);text-decoration:none}
  </style>

  <!-- Versioned CDNs (reliable loading) -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3.1.0/dist/topojson-client.min.js"></script>

  <!-- Vega stack (pinned versions) -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5.25.0/build/vega.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.17.0/build/vega-lite.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.25.0/build/vega-embed.min.js"></script>
</head>
<body>
  <header>
    <h1>How Australians got to work?</h1>
    <div class="subtitle">AUSTRALIA-WIDE OVERVIEW (CAPITALS) • GREATER MELBOURNE DETAIL • 2016–2021</div>
    <p class="intro">
      Between 2016–2021 Australians shifted away from shared transport toward <strong>working from home</strong> and—when travel was needed—<strong>driving</strong>.
      The shift was strongest in New South Wales and Victoria. Below we compare states in 2021 and then zoom into Greater Melbourne to see where change was concentrated.
    </p>
  </header>

  <div class="wrap">
    <div class="grid">

      <!-- ================= Australia-wide (States) Map ================= -->
      <section class="card" id="aus-card">
        <div class="pad">
          <h2>Driving to work vs Working from home (2021)</h2>
          <p class="muted">
            Choose a metric to colour each state by the <strong>% of workers</strong> who either <em>drove to work</em> or <em>worked from home</em> in 2021.
          </p>

          <!-- visible toggle (re-embeds spec) -->
          <div class="metric-toggle" aria-label="Metric">
            <span style="font-weight:600;color:#0f172a">Metric:</span>
            <div class="seg" role="tablist" aria-label="Choose metric">
              <input type="radio" name="metric" id="mDrivers" value="driver_pct" checked>
              <label for="mDrivers">Driving</label>
              <input type="radio" name="metric" id="mWFH" value="wfh_pct_2021">
              <label for="mWFH">Worked from home</label>
            </div>
          </div>

          <div class="map-grid map-grid--notes-left">
            <aside class="side-notes">
              <h3>What the map shows</h3>
              <p>
                The east recorded the biggest lift in <strong>home-based work</strong>: Sydney ~<strong>31%</strong> and Melbourne ~<strong>26%</strong>, lowering their driving shares.
              </p>
              <p>
                Further north and west the pattern flips—<strong>Queensland</strong> and <strong>Western Australia</strong> remain more <strong>car-oriented</strong>
                (Brisbane ~<strong>56%</strong> driving; Perth ~<strong>63%</strong>).
              </p>
              <p>
                <strong>South Australia</strong>, <strong>Tasmania</strong> and the <strong>Northern Territory</strong> also leaned toward driving with modest WFH uptake.
              </p>
              <p>
                Overall, by 2021 the commute split between <strong>staying home</strong> and <strong>driving</strong>, with public transport still below pre-pandemic levels.
              </p>
            </aside>

            <div id="ausMap" aria-live="polite"></div>
          </div>

          <div class="loading" id="ausMapLoading">Loading chart…</div>
          <div class="card-footer">
            <a href="https://raw.githubusercontent.com/khanhl123/FIT3179-A2/main/specs/aus_map.json" target="_blank" rel="noopener">View spec</a>
          </div>
        </div>
      </section>

      <!-- ================= Why the commute looks like this ================= -->
      <section class="card">
        <div class="pad">
          <h2>Why the commute looks like this</h2>

          <div class="side-notes">
            <h3>Where people work</h3>
            <p>
              Regional cities have a much higher share of residents who work <strong>in the same local area</strong>.
              Townsville (~<strong>92%</strong>), Ballarat (~<strong>85%</strong>) and Launceston (~<strong>81%</strong>) lead the list, with Cairns also high (~<strong>67%</strong>).
              Capital cities sit lower—Sydney (~<strong>33%</strong>), Melbourne (~<strong>31%</strong>), Brisbane (~<strong>28%</strong>) and Adelaide (~<strong>27%</strong>)—
              while Darwin (~<strong>45%</strong>) and Hobart (~<strong>42%</strong>) sit mid-range.
            </p>
            <h3>How long trips are</h3>
            <p>
              The national commute-time curve peaks at <strong>15–25 minutes</strong> (each a little over one-fifth of commuters). Shares taper after ~35 minutes;
              only about one in seven Australians travel <strong>55+ minutes</strong>, and very long trips (60+ minutes) are rare.
            </p>
          </div>

          <div class="two-grid">
            <div>
              <h3 style="margin:8px 0 6px;font-weight:700">Share working locally, by city (2021)</h3>
              <div id="cityLocalWork"></div>
              <div class="loading" id="localLoading">Loading chart…</div>
              <div class="card-footer">
                <a href="https://raw.githubusercontent.com/khanhl123/FIT3179-A2/main/specs/city_local_work.json" target="_blank" rel="noopener">View spec</a>
              </div>
            </div>

            <div>
              <h3 style="margin:8px 0 6px;font-weight:700">Commute time distribution — Australia (2021)</h3>
              <div id="nationalCommuteTime"></div>
              <div class="loading" id="timeLoading">Loading chart…</div>
              <div class="card-footer">
                <a href="https://raw.githubusercontent.com/khanhl123/FIT3179-A2/main/specs/commute_time.json" target="_blank" rel="noopener">View spec</a>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ================= Greater Melbourne — Dot map by mode & year ================= -->
      <section class="card">
        <div class="pad">
          <h2>Greater Melbourne — Dot map by mode &amp; year</h2>
          <div class="controls">
            <label>Mode:</label>
            <select id="modeSel" aria-label="Mode select"></select>
            <span style="margin-left:8px">Year:</span>
            <button class="btn" data-year="2016" id="y2016" aria-pressed="false">2016</button>
            <button class="btn active" data-year="2021" id="y2021" aria-pressed="true">2021</button>
            <label style="margin-left:12px; display:flex; align-items:center; gap:6px;">
              <input type="checkbox" id="showLabels" />
              Labels
            </label>
          </div>
          <p class="muted">
            Dot size = share (%). Colour uses a single-hue, colour-blind-safe <strong>blue</strong> scale (<strong>% of workers</strong>).
            Story: inner Melbourne swung from strong train/tram in 2016 to much higher <strong>working from home</strong> in 2021,
            while outer suburbs remained more car-reliant.
          </p>
          <div class="banner" id="joinNote" style="display:none">Note: coordinates were joined from <code>lga_centroids.csv</code>.</div>
          <div class="legend" id="legend">
            <span class="legend-title">% of workers</span>
          </div>
        </div>
        <div id="mapBox" aria-live="polite"></div>
        <div class="loading" id="melbLoading">Loading map…</div>
        <div class="pad">
          <p class="muted" style="margin-top:4px">
            Central municipalities gained the most <strong>WFH</strong> and saw the largest <strong>public-transport</strong> drop; middle/outer suburbs stayed more <strong>car-driver</strong>.
          </p>
          <div class="card-footer">
            <a href="https://raw.githubusercontent.com/khanhl123/FIT3179-A2/main/specs/melb_dots.json" target="_blank" rel="noopener">View spec</a>
          </div>
        </div>
      </section>

      <!-- ================= Slope Chart Section ================= -->
      <section class="card">
        <div class="pad">
          <h2>Shift in Transportation Modes (2016–2021)</h2>
          <p class="muted">Click a mode (legend or line) to highlight it. Others dim. Double-click anywhere to reset.</p>
          <div id="slopeChart"></div>
          <div class="loading" id="slopeLoading">Loading chart…</div>
          <div class="slope-grid" style="margin-top:8px">
            <aside class="side-notes" style="grid-column:1/-1">
              <h3>What stands out</h3>
              <p><strong>Car (driver)</strong> remained dominant but fell from ~<strong>62%</strong> (2016) to ~<strong>53%</strong> (2021).</p>
              <p><strong>Worked at home</strong> rose the most—from ~<strong>5%</strong> to ~<strong>21%</strong>.</p>
              <p><strong>Public transport</strong> contracted sharply—train and bus both roughly halved. Walking, cycling and car-passenger edged down.</p>
              <p>Overall, Australians moved from <strong>shared seats</strong> toward <strong>home-based work</strong> and—when travel was required—<strong>private cars</strong>.</p>
            </aside>
          </div>
          <div class="card-footer">
            <a href="https://raw.githubusercontent.com/khanhl123/FIT3179-A2/main/specs/slope_modes.json" target="_blank" rel="noopener">View spec</a>
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- ===================== Scripts: embed AFTER DOM ===================== -->

  <!-- AUS map (external toggle + sequential blues; annotations included) -->
  <script>
    const AUS_CSV  = "https://khanhl123.github.io/FIT3179-A2/gccsa_capitals_wfh_drivers_2021.csv";
    const AUS_TOPO = "https://khanhl123.github.io/FIT3179-A2/ste_2021.json";

    function ausSpec(metricKey){
      // metricKey ∈ {'driver_pct','wfh_pct_2021'}
      const metricTitle = metricKey === "driver_pct" ? "Drivers (%)" : "WFH (%)";
      return {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        width: "container",
        height: 420,
        projection: { type: "equalEarth", rotate: [-134, 0, 0] },
        data: { url: AUS_TOPO, format: { type: "topojson", feature: "STE_2021_AUST_GDA2020" } },
        transform: [
          { calculate: "(datum.properties && (datum.properties['STE_NAME_2021'] || datum.properties['STE_NAME21'] || datum.properties['STATE_NAME']))", as: "state_name" },
          { lookup: "state_name", from: { data: { url: AUS_CSV }, key: "STE_NAME_2021", fields: ["driver_pct","wfh_pct_2021"] } },
          { calculate: `'${metricTitle}'`, as: "metric_name" },
          { calculate: metricKey === 'driver_pct' ? "datum.driver_pct" : "datum.wfh_pct_2021", as: "metric_value" },
          { calculate: "'2021'", as: "map_year" }
        ],
        layer: [
          {
            mark: { type: "geoshape", stroke: "#94a3b8", strokeWidth: 0.8 },
            encoding: {
              color: {
                field: "metric_value", type: "quantitative", title: "Proportion (%)",
                scale: { domain: [0, 80], scheme: "blues" },
                legend: { format: ".0f" }
              },
              tooltip: [
                { field: "state_name", title: "State/Territory" },
                { field: "map_year",  title: "Year" },
                { field: "metric_name", title: "Metric" },
                { field: "metric_value", title: "Proportion (%)", format: ".1f" }
              ]
            }
          },
          // simple text annotations (static)
          {
            data: {
              values: [
                { lon:151.2, lat:-33.9, label:"Sydney ~31% WFH (2021)" },
                { lon:144.9, lat:-37.8, label:"Melbourne ~26% WFH" },
                { lon:115.9, lat:-31.95, label:"Perth ~63% driving" }
              ]
            },
            transform:[{calculate:"datum.label",as:"txt"}],
            mark:{type:"text", dy:-6, fontSize:10, color:"#0f172a", opacity:0.85, stroke:"#fff", strokeWidth:2},
            encoding:{ longitude:{field:"lon"}, latitude:{field:"lat"}, text:{field:"txt"} }
          },
          { mark: { type: "geoshape", fill: null, stroke: "#334155", strokeWidth: 0.9 } }
        ],
        config:{ view:{stroke:null}, axis:{ labelFontSize:12, titleFontSize:13 } }
      };
    }

    async function embedAus(metricKey){
      const loading = document.getElementById("ausMapLoading");
      loading.style.display = "block";
      try{
        await vegaEmbed("#ausMap", ausSpec(metricKey), {actions:false, renderer:'svg'});
        loading.style.display = "none";
      }catch(err){
        console.error("AUS map error:", err);
        document.getElementById("ausMap").innerHTML =
          '<div class="muted">Could not load the Australia-wide map. Check the TopoJSON and CSV URLs.</div>';
      }
    }

    // set up toggle
    document.getElementById("mDrivers").addEventListener("change", e => e.target.checked && embedAus("driver_pct"));
    document.getElementById("mWFH").addEventListener("change", e => e.target.checked && embedAus("wfh_pct_2021"));
    // initial
    embedAus("driver_pct");
  </script>

  <!-- Melbourne dot map (sequential blues, precise legend bins, improved tooltip) -->
  <script>
  (async function () {
    const topoUrl = "LGA_2021_AUST_GDA2020.json";
    const dataUrl = "B__Wide_comparison__Area___mode__2016_vs_2021_.csv";
    const centUrl = "lga_centroids.csv";

    const MODE_ALIASES = new Map([
      ["taxi/ride-share","Taxi/Rideshare"],["taxi/ride share","Taxi/Rideshare"],
      ["car - as driver","Car driver"],["car- as driver","Car driver"],
      ["car - as passenger","Car passenger"],["walked only","Walk"]
    ]);
    const normName = s => String(s||"").toLowerCase().replace(/\s*\([^)]*\)\s*/g," ").replace(/^city of\s+/,"").replace(/[–—-]+/g," ").replace(/\s+/g," ").trim();
    const normMode = s => MODE_ALIASES.get(normName(s)) || String(s);
    const toNum = x => { if (x == null) return NaN; const v=+String(x).replace(/[,%]/g,"").trim(); return Number.isFinite(v)?v:NaN; };
    const endsWithN = a => /\(\s*N\s*\)\s*$/i.test(String(a||"").trim());

    /* bins: 0–5,6–10,11–20,...71–80 (sequential blues) */
    const thresholds = [5,10,20,30,40,50,60,70];
    const colors = [
      "#dbeafe","#bfdbfe","#93c5fd","#60a5fa",
      "#3b82f6","#2563eb","#1d4ed8","#1e40af","#172554"
    ];
    const colorScale = d3.scaleThreshold().domain(thresholds).range(colors);
    function labelFor(v){
      if (!Number.isFinite(v)) return "No data";
      if (v <= 5)  return "0–5%";
      if (v <= 10) return "6–10%";
      if (v <= 20) return "11–20%";
      if (v <= 30) return "21–30%";
      if (v <= 40) return "31–40%";
      if (v <= 50) return "41–50%";
      if (v <= 60) return "51–60%";
      if (v <= 70) return "61–70%";
      return "71–80%";
    }

    /* Legend (bins + title already in DOM) */
    const legend = document.getElementById("legend");
    ["0–5%","6–10%","11–20%","21–30%","31–40%","41–50%","51–60%","61–70%","71–80%"]
      .forEach((lab,i) => {
        const el = document.createElement("div");
        el.innerHTML = `<span class="sw" style="background:${colors[i]}"></span>
                        <span style="font-size:12px;color:#475569">${lab}</span>`;
        legend.appendChild(el);
      });

    const width = document.getElementById("mapBox").clientWidth;
    const height = document.getElementById("mapBox").clientHeight;
    const svg = d3.select("#mapBox").append("svg").attr("viewBox", [0,0,width,height]);
    const gBase = svg.append("g");
    const gDots = svg.append("g");
    const gLabels = svg.append("g");
    const tip = d3.select("body").append("div").attr("class","tooltip").style("opacity",0);

    document.getElementById("melbLoading").style.display="block";
    const [topology, rawDataAll, centroidsAll] = await Promise.all([
      d3.json(topoUrl),
      d3.csv(dataUrl),
      d3.csv(centUrl, d3.autoType)
    ]).catch(err => {
      console.error("Melbourne data error:", err);
      document.getElementById("mapBox").innerHTML = '<div class="muted">Could not load the Melbourne map data.</div>';
    });

    if(!topology || !rawDataAll || !centroidsAll) return;

    const rawData0 = rawDataAll.filter(d => !endsWithN(d.Area));
    const EXCLUDE = new Set(["total","not stated","other","other mode","did not go to work"]);
    const centroids = centroidsAll.filter(d => !endsWithN(d.Area));

    const objName = (topology.objects && topology.objects.LGA_2021_AUST_GDA2020)
      ? "LGA_2021_AUST_GDA2020" : Object.keys(topology.objects)[0];
    const geo = topojson.feature(topology, topology.objects[objName]);
    const sampleProps = (geo.features[0] && geo.features[0].properties) || {};
    const melb = ("GCC_NAME21" in sampleProps)
      ? {type:"FeatureCollection",features: geo.features.filter(f => f.properties.GCC_NAME21 === "Greater Melbourne")}
      : geo;

    const projection = d3.geoMercator().fitSize([width,height], melb);
    const path = d3.geoPath(projection);
    gBase.append("g")
      .selectAll("path").data(melb.features).join("path")
      .attr("d", path).attr("fill", "#eef2ff")
      .attr("stroke", "#94a3b8").attr("stroke-width", 0.6);

    const hasLon = rawData0.length && ("lon" in rawData0[0]);
    const hasLat = rawData0.length && ("lat" in rawData0[0]);

    let data = rawData0.map(d => ({
      Area: d.Area,
      area_norm: normName(d.Area),
      mode: normMode(d.mode ?? d.Mode ?? d.data_label ?? d["Data label"]),
      share_2016: toNum(d.share_2016 ?? d["2016%"] ?? d["2016 %"]),
      share_2021: toNum(d.share_2021 ?? d["2021%"] ?? d["2021 %"]),
      delta_pp: toNum(d.delta_pp ?? (toNum(d["2021%"])-toNum(d["2016%"]))),
      lon: hasLon ? +d.lon : NaN,
      lat: hasLat ? +d.lat : NaN
    })).filter(d => !EXCLUDE.has(normName(d.mode)));

    if (!hasLon || !hasLat) {
      const centByArea = new Map(centroids.map(c => [normName(c.Area), {lon:+c.lon, lat:+c.lat}]));
      data.forEach(d => { const c = centByArea.get(d.area_norm); if (c) { d.lon = c.lon; d.lat = c.lat; } });
      document.getElementById("joinNote").style.display = "block";
    }

    const modes = Array.from(new Set(data.map(d => d.mode))).filter(Boolean).sort((a,b)=>a.localeCompare(b));
    const modeSel = document.getElementById("modeSel");
    modes.forEach(m => modeSel.appendChild(new Option(m, m)));

    const y2016 = document.getElementById("y2016");
    const y2021 = document.getElementById("y2021");
    const showLabels = document.getElementById("showLabels");
    function setYear(y){
      y2016.classList.toggle("active", y===2016); y2016.setAttribute("aria-pressed", y===2016);
      y2021.classList.toggle("active", y===2021); y2021.setAttribute("aria-pressed", y===2021);
      render(modeSel.value, y, showLabels.checked);
    }
    modeSel.addEventListener("change", () => setYear(y2016.classList.contains("active") ? 2016 : 2021));
    y2016.addEventListener("click", () => setYear(2016));
    y2021.addEventListener("click", () => setYear(2021));
    showLabels.addEventListener("change", () => setYear(y2016.classList.contains("active") ? 2016 : 2021));

    function render(mode, year, withLabels){
      const rows = data.filter(d => d.mode === mode);
      const pts = rows.map(d => {
        const value = year === 2016 ? d.share_2016 : d.share_2021;
        const hasValue = Number.isFinite(value);
        const hasCoord = Number.isFinite(d.lon) && Number.isFinite(d.lat);
        const p = hasCoord ? projection([d.lon, d.lat]) : null;
        return { Area: d.Area, x0: p? p[0]:undefined, y0: p? p[1]:undefined, value, hasValue, mode, year };
      }).filter(d => d.x0 !== undefined);

      const vMax = d3.max(pts.filter(d => d.hasValue), d => d.value) || 10;
      const r = d3.scaleSqrt().domain([0, vMax]).range([2, 10]);
      const nodes = pts.map(d => ({ ...d, x: d.x0, y: d.y0 }));
      const sim = d3.forceSimulation(nodes)
        .force("x", d3.forceX(d => d.x0).strength(0.20))
        .force("y", d3.forceY(d => d.y0).strength(0.20))
        .force("collide", d3.forceCollide(d => r(d.hasValue ? d.value : 0.1) + 1.5))
        .stop();
      for (let i = 0; i < 120; i++) sim.tick();

      const circles = gDots.selectAll("circle").data(nodes, d => d.Area + "__" + mode);
      circles.join(
        enter => enter.append("circle")
          .attr("cx", d => d.x0).attr("cy", d => d.y0).attr("r", 0)
          .attr("fill", d => Number.isFinite(d.value) ? colorScale(d.value) : "#cbd5e1")
          .attr("fill-opacity", d => d.hasValue ? 0.9 : 0.9)
          .attr("stroke", "#0f172a").attr("stroke-opacity", d => d.hasValue ? 0.25 : 0.1).attr("stroke-width", 0.8)
          .on("mousemove", (e,d) => {
            const txt = d.hasValue
              ? `${d.Area} — ${d.mode} — ${d.year}: ${d.value.toFixed(1)}% (${labelFor(d.value)})`
              : `${d.Area} — ${d.mode}: no data`;
            tip.style("opacity",1).html(txt)
               .style("left",(e.pageX+12)+"px").style("top",(e.pageY-28)+"px");
          })
          .on("mouseleave", () => tip.style("opacity",0))
          .transition().duration(400)
          .attr("cx", d => d.x).attr("cy", d => d.y).attr("r", d => r(d.hasValue ? d.value : 0.1)),
        update => update.transition().duration(300)
          .attr("cx", d => d.x).attr("cy", d => d.y)
          .attr("fill", d => Number.isFinite(d.value) ? colorScale(d.value) : "#cbd5e1")
          .attr("r", d => r(d.hasValue ? d.value : 0.1)),
        exit => exit.transition().duration(200).attr("r",0).remove()
      );

      const labels = gLabels.selectAll("text").data(withLabels ? nodes.filter(d => d.hasValue) : [], d => d.Area + "__" + mode);
      labels.join(
        enter => enter.append("text")
          .attr("class","label").attr("x", d => d.x + 10).attr("y", d => d.y + 3)
          .style("opacity", 0).text(d => `${d.value.toFixed(0)}%`)
          .transition().duration(250).style("opacity", 1),
        update => update.transition().duration(250).attr("x", d => d.x + 10).attr("y", d => d.y + 3).text(d => `${d.value.toFixed(0)}%`),
        exit => exit.transition().duration(150).style("opacity",0).remove()
      );
    }

    setYear(2021);
    document.getElementById("melbLoading").style.display="none";
  })();
  </script>

  <!-- Slope chart (pinned versions + loading placeholder + safe palette) -->
  <script>
    (function(){
      const container = document.getElementById('slopeChart');
      const measured = container.clientWidth || container.getBoundingClientRect().width || 900;
      const w = Math.min(560, Math.max(320, measured));

      const slopeSpec = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "description": "Change in transport mode proportions (2016–2021).",
        "data": {"url":"https://raw.githubusercontent.com/khanhl123/FIT3179-A2/main/proportion_transportation_slopchart.csv","format":{"type":"csv"}},
        "transform": [
          {"filter": "indexof(['Total','Not stated','Other','Other Mode','Other mode','Did not go to work','Truck'], datum.mode) < 0"},
          {"fold": ["prop_2016_pct","prop_2021_pct"], "as": ["fold_key","Proportion"]},
          {"calculate": "datum.fold_key === 'prop_2016_pct' ? '2016' : '2021'", "as": "Year"},
          {"calculate": "toNumber(datum.Proportion)", "as": "Proportion"}
        ],
        "params": [{"name":"pick","select":{"type":"point","fields":["mode"],"on":"click","clear":"dblclick"},"bind":"legend","empty":"all"}],
        "mark": {"type":"line","point":true},
        "encoding": {
          "x": {"field":"Year","type":"ordinal","sort":["2016","2021"],"axis":{"title":"Year"}},
          "y": {"field":"Proportion","type":"quantitative","scale":{"domain":[0,70]},"axis":{"title":"Proportion (%)","values":[0,10,20,30,40,50,60,70]}},
          "color": {
            "field":"mode","type":"nominal","legend":{"title":"Mode of Transport"},
            "scale":{"range":["#4e79a7","#e15759","#59a14f","#f28e2b","#edc948","#76b7b2","#b07aa1","#ff9da7","#9c755f","#bab0ac"]}  /* Tableau-10 (colour-blind friendly) */
          },
          "opacity": {"condition":{"param":"pick","value":1},"value":0.15},
          "size": {"condition":{"param":"pick","value":3},"value":2},
          "tooltip": [
            {"field":"mode","title":"Mode"},
            {"field":"Year","title":"Year"},
            {"field":"Proportion","title":"Proportion (%)","format":".1f"}
          ]
        },
        "width": w,
        "height": 400,
        "config": {"axis":{"labelFontSize":12,"titleFontSize":13},"legend":{"labelFontSize":12,"titleFontSize":13},"line":{"interpolate":"monotone"},"view":{"stroke":null}}
      };

      vegaEmbed('#slopeChart', slopeSpec, { actions:false, renderer:'svg' })
        .then(()=>{document.getElementById("slopeLoading").style.display="none";})
        .catch(err => {
          console.error('Slope chart error:', err);
          document.getElementById("slopeChart").innerHTML =
            '<div class="muted">Could not load the slope chart. Check the CSV URL/headers.</div>';
        });
    })();
  </script>

  <!-- Two small charts (with placeholders) -->
  <script>
  (function(){
    const urlLocal = "https://khanhl123.github.io/FIT3179-A2/work_locally_by_city_2021.csv";
    const urlTime  = "https://khanhl123.github.io/FIT3179-A2/commute_time_distribution_2021.csv";

    const localSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      data: { url: urlLocal, format: { type: "csv" } },
      width: 520,
      height: { step: 26 },
      transform: [{ calculate: "datum.city_type", as: "City type" }],
      layer: [
        {
          mark: { type: "bar", cornerRadiusEnd: 4 },
          encoding: {
            y: { field: "city", type: "nominal", sort: "-x", title: null },
            x: {
              field: "pct_work_locally", type: "quantitative",
              title: "Work locally (%)", scale: { domain: [0, 100] }
            },
            color: {
              field: "City type", type: "nominal",
              scale: { domain: ["Capital","Regional"], range: ["#3b82f6","#f59e0b"] },
              legend: { title: "City type" }
            },
            tooltip: [
              { field: "city", title: "City" },
              { field: "City type" },
              { field: "pct_work_locally", title: "Work locally (%)", format: ".1f" }
            ]
          }
        },
        {
          mark: { type: "text", align: "left", baseline: "middle", dx: 4, fontSize: 11, color: "#0f172a" },
          encoding: {
            y: { field: "city", type: "nominal", sort: "-x" },
            x: { field: "pct_work_locally", type: "quantitative" },
            text: { field: "pct_work_locally", type: "quantitative", format: ".1f" }
          }
        }
      ],
      config: { view: { stroke: null }, axis: { labelFontSize: 12, titleFontSize: 13 } }
    };

    const timeSpec = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      data: { url: urlTime, format: { type: "csv" } },
      width: 520,
      height: 220,
      transform: [
        { calculate: "(datum.time_bin || datum.bin || datum.minutes || datum.Time || datum.category || datum.Category)", as: "BinLabel" },
        { calculate: "parseInt(datum.BinLabel)", as: "BinNum" },
        { calculate: "toNumber(replace((datum.commuters || datum.count || datum.Count || datum.total || datum.Total || ''), ',',''))", as: "Commuters" },
        { filter: "isValid(datum.BinLabel) && isValid(datum.Commuters)" },
        { joinaggregate: [{ op: "sum", field: "Commuters", as: "AllCommuters" }] },
        { calculate: "datum.Commuters / datum.AllCommuters * 100", as: "SharePct" }
      ],
      mark: { type: "line", point: true, interpolate: "monotone", color: "#2563eb" },
      encoding: {
        x: { field: "BinLabel", type: "ordinal", sort: {"field":"BinNum","order":"ascending"}, title: "Commute time (minutes)" },
        y: { field: "SharePct", type: "quantitative", title: "Share of commuters (%)", scale: { domain: [0, 100] } },
        order: { field: "BinNum", type: "quantitative" },
        tooltip: [
          { field: "BinLabel", title: "Time" },
          { field: "SharePct", title: "Share (%)", format: ".1f" },
          { field: "Commuters", title: "Commuters", format: "," }
        ]
      },
      config: { view: { stroke: null }, axis: { labelFontSize: 12, titleFontSize: 13 } }
    };

    vegaEmbed("#cityLocalWork", localSpec, {actions:false, renderer:'svg'})
      .then(()=>{document.getElementById("localLoading").style.display="none";})
      .catch(err => {
        console.error('Local work chart error:', err);
        document.getElementById("cityLocalWork").innerHTML =
          '<div class="muted">Could not load data. Check the CSV path and file access.</div>';
      });

    vegaEmbed("#nationalCommuteTime", timeSpec, {actions:false, renderer:'svg'})
      .then(()=>{document.getElementById("timeLoading").style.display="none";})
      .catch(err => {
        console.error('Commute time chart error:', err);
        document.getElementById("nationalCommuteTime").innerHTML =
          '<div class="muted">Could not load data. Check the CSV path and file access.</div>';
      });
  })();
  </script>

  <!-- ================= Footer (credits & date) ================= -->
  <footer class="site">
    <p><strong>Data &amp; Credits.</strong> Australian Bureau of Statistics (ABS) — 2021 Census.
      State boundaries: <em>STE_2021_AUST_GDA2020</em> (TopoJSON). City/local data: custom aggregations from ABS tables.
      Charts made with Vega-Lite. Built by <em>Your Name</em>.
      <br/>Updated: <time datetime="2025-10-20">20 Oct 2025</time>.
      &nbsp;|&nbsp; <a href="https://raw.githubusercontent.com/khanhl123/FIT3179-A2/main/design/Five-Design-Sheets.pdf" target="_blank" rel="noopener">Design process (PDF)</a>
    </p>
  </footer>
</body>
</html>
