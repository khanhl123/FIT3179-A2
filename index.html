<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>How Australians got to work?</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f7f9fc; --text:#0f172a; --muted:#6b7280; --card:#ffffff; --border:#e5e7eb;
      --accent:#2563eb;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    header{padding:28px 20px;text-align:center;}
    h1{margin:0;font-size:clamp(28px,3.5vw,44px);letter-spacing:-0.02em}
    .subtitle{margin-top:6px;color:var(--muted);font-size:14px}
    .wrap{max-width:1200px;margin:0 auto;padding:0 16px 40px}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:20px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 18px rgba(15,23,42,.06)}
    .card h2{font-size:20px;margin:0 0 14px}
    .pad{padding:18px}
    #mapBox{height:560px}
    .legend{font-size:12px;color:var(--muted)}
    .placeholder{display:flex;flex-direction:column;justify-content:center;align-items:center;gap:8px;height:100%}
    .pill{padding:6px 10px;border:1px dashed var(--border);border-radius:999px;color:var(--muted);background:#fafafa}
    .warn{color:#b45309;background:#fff7ed;border:1px solid #fde68a;padding:8px 10px;border-radius:8px;margin-top:8px;display:none}
    svg{display:block;width:100%;height:100%}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
</head>
<body>
  <header>
    <h1>How Australians got to work?</h1>
    <div class="subtitle">Exploring commuting shifts between the 2016 and 2021 Censuses with a focus on Greater Melbourne.</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- MAP -->
      <section class="card">
        <div class="pad">
          <h2>Greater Melbourne — SA3 Outline</h2>
          <div class="legend" id="legendText">Tip: This is the base map. We’ll color it once the data join succeeds.</div>
          <div class="warn" id="joinWarn">Heads up: your CSV doesn’t match SA3 names, so the choropleth wasn’t applied. The outline still renders.</div>
        </div>
        <div id="mapBox"></div>
      </section>

      <!-- RIGHT SIDEBAR -->
      <aside class="card">
        <div class="pad placeholder">
          <div style="font-weight:600;font-size:18px">（Placeholder）</div>
          <div style="text-align:center;color:var(--muted)">Add second chart here</div>
          <div class="pill">Ready for your next viz</div>
        </div>
      </aside>
    </div>
  </div>

  <script>
  (async function () {
    const mapFile = "SA3_2021_AUST_GDA2020.json";      // exact names from your repo
    const csvFile = "proportion_transportation_map.csv";

    const width = document.getElementById("mapBox").clientWidth;
    const height = document.getElementById("mapBox").clientHeight;

    const svg = d3.select("#mapBox").append("svg")
      .attr("viewBox", [0, 0, width, height]);

    const g = svg.append("g");

    // Load files
    const [topology, table] = await Promise.all([
      d3.json(mapFile),
      d3.csv(csvFile)
    ]);

    // Extract features and filter to Greater Melbourne (GCC_NAME21)
    const geo = topojson.feature(topology, topology.objects.SA3_2021_AUST_GDA2020);
    const melb = {
      type: "FeatureCollection",
      features: geo.features.filter(f => f.properties.GCC_NAME21 === "Greater Melbourne")
    };

    // Projection fit to Greater Melbourne
    const projection = d3.geoMercator().fitSize([width, height], melb);
    const path = d3.geoPath(projection);

    // Draw base fill (light) so you always see the outline
    g.append("g")
      .selectAll("path")
      .data(melb.features)
      .join("path")
      .attr("d", path)
      .attr("fill", "#eef2ff")          // light base color
      .attr("stroke", "#94a3b8")
      .attr("stroke-width", 0.6);

    // Try to build a value-by-SA3 map from your CSV
    // Your CSV has LGA names like "City of Melbourne", but the map is SA3 (e.g., "Melbourne City").
    // This will likely NOT match — we keep it defensive.
    const valueBySa3Name = new Map();
    // Example: if you later aggregate to SA3 and create columns:
    // SA3_NAME21, pt_share_2016, pt_share_2021, delta_pt_pp
    // then update the accessor below accordingly.
    let hadAnyMatch = false;

    table.forEach(row => {
      // Attempt to use row.Area as SA3 name (will fail for LGA-based rows)
      const key = (row.Area || "").trim();
      // Choose a metric to color by if you have it; here we look for 'delta_pp'
      const val = +row.delta_pp || NaN;
      if (key && !Number.isNaN(val)) valueBySa3Name.set(key, val);
    });

    // Color scale (only used if a value matches)
    const vals = Array.from(valueBySa3Name.values());
    const color = d3.scaleDiverging()
      .domain([d3.min(vals) || -10, 0, d3.max(vals) || 10])
      .interpolator(d3.interpolateRdBu)
      .unknown("#eef2ff");

    // Try to recolor if there are matches
    g.selectAll("path")
      .attr("fill", d => {
        const v = valueBySa3Name.get(d.properties.SA3_NAME21);
        if (v !== undefined) { hadAnyMatch = true; return color(v); }
        return "#eef2ff";
      });

    // Boundaries on top
    g.append("path")
      .datum(topojson.mesh(topology, topology.objects.SA3_2021_AUST_GDA2020, (a,b) =>
        a.properties.GCC_NAME21 === "Greater Melbourne" &&
        b.properties.GCC_NAME21 === "Greater Melbourne"))
      .attr("d", path)
      .attr("fill", "none")
      .attr("stroke", "#475569")
      .attr("stroke-width", 0.8);

    // Show a gentle warning if join failed
    if (!hadAnyMatch) {
      document.getElementById("joinWarn").style.display = "block";
      // Helpful console hint for you during development
      console.warn("No SA3 name matches between CSV and map. Your CSV looks LGA-based (e.g., 'City of Melbourne') while the map is SA3 (e.g., 'Melbourne City').");
    } else {
      document.getElementById("legendText").textContent = "Δ Public transport (pp, 2016 → 2021)";
    }
  })();
  </script>
</body>
</html>
