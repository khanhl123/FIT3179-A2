<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>How Australians got to work?</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{margin:0;background:#f7f9fc;color:#0f172a;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    header{padding:28px 20px;text-align:center;}
    h1{margin:0;font-size:clamp(28px,3.5vw,44px);letter-spacing:-0.02em}
    .subtitle{margin-top:6px;color:#64748b;font-size:14px}
    .wrap{max-width:1200px;margin:0 auto;padding:0 16px 40px}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:20px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 4px 18px rgba(15,23,42,.06)}
    .pad{padding:18px}
    .card h2{font-size:20px;margin:0 0 12px}
    #mapBox{height:620px}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:6px 0 10px}
    select,button{font:inherit}
    .btn{padding:6px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer}
    .btn.active{background:#0f172a;color:#fff;border-color:#0f172a}
    .muted{color:#64748b;font-size:12px}
    .tooltip{position:absolute;pointer-events:none;background:#111827;color:#fff;padding:8px 10px;border-radius:10px;font-size:12px;box-shadow:0 6px 18px rgba(0,0,0,.2)}
    .banner{margin-top:8px;color:#b45309;background:#fff7ed;border:1px solid #fde68a;padding:8px 10px;border-radius:8px;display:none}
    svg{display:block;width:100%;height:100%}
    @media (max-width: 960px){ .grid{grid-template-columns:1fr} #mapBox{height:520px} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
</head>
<body>
  <header>
    <h1>How Australians got to work?</h1>
    <div class="subtitle">Dot map of mode share by LGA/suburb (2016 vs 2021) over a Greater Melbourne outline.</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <section class="card">
        <div class="pad">
          <h2>Greater Melbourne — Dot map by mode & year</h2>
          <div class="controls">
            <label>Mode:</label>
            <select id="modeSel"></select>
            <span style="margin-left:8px">Year:</span>
            <button class="btn" data-year="2016" id="y2016">2016</button>
            <button class="btn active" data-year="2021" id="y2021">2021</button>
          </div>
          <div class="muted">Dot size = share (%). Grey dots = no value for that Area+mode+year.</div>
          <div class="banner" id="joinNote">Note: lat/lon were joined from <code>lga_centroids.csv</code> (the data file had no coordinates).</div>
        </div>
        <div id="mapBox"></div>
      </section>

      <aside class="card">
        <div class="pad">
          <h2>(Placeholder) 2016 vs 2021 by Mode</h2>
          <p class="muted">We’ll hook this panel to dot clicks next.</p>
        </div>
      </aside>
    </div>
  </div>

  <script>
  (async function () {
    // ===== File names (same folder as index.html) =====
    const topoUrl = "SA3_2021_AUST_GDA2020.json";
    const dataUrl = "B__Wide_comparison__Area___mode__2016_vs_2021_.csv";
    const centUrl = "lga_centroids.csv";

    // Helpers
    const MODE_ALIASES = new Map([
      ["taxi/ride-share","Taxi/Rideshare"],["taxi/ride share","Taxi/Rideshare"],
      ["car - as driver","Car driver"],["car- as driver","Car driver"],
      ["car - as passenger","Car passenger"],["walked only","Walk"]
    ]);
    function normName(s){
      return String(s||"")
        .toLowerCase()
        .replace(/\s*\([^)]*\)\s*/g," ") // drop (P) etc. for joining, not for display
        .replace(/^city of\s+/,"")
        .replace(/[–—-]+/g," ")
        .replace(/\s+/g," ").trim();
    }
    function normMode(s){
      const raw = normName(s);
      return MODE_ALIASES.get(raw) || String(s);
    }
    function toNum(x){
      if (x == null) return NaN;
      const s = String(x).replace(/,/g,"").replace(/%/g,"").trim();
      const v = +s;
      return Number.isFinite(v) ? v : NaN;
    }
    const endsWithN = a => /\(\s*N\s*\)\s*$/i.test(String(a||"").trim());

    // SVG
    const width = document.getElementById("mapBox").clientWidth;
    const height = document.getElementById("mapBox").clientHeight;
    const svg = d3.select("#mapBox").append("svg").attr("viewBox", [0,0,width,height]);
    const gBase = svg.append("g");
    const gDots = svg.append("g");
    const tip = d3.select("body").append("div").attr("class","tooltip").style("opacity",0);

    // Load files
    const [topology, rawDataAll, centroidsAll] = await Promise.all([
      d3.json(topoUrl),
      d3.csv(dataUrl),
      d3.csv(centUrl, d3.autoType)
    ]);

    // *** NEW: drop any Area that ends with "(N)" in BOTH datasets ***
    const rawData = rawDataAll.filter(d => !endsWithN(d.Area));
    const centroids = centroidsAll.filter(d => !endsWithN(d.Area));

    // Background outline
    const geo = topojson.feature(topology, topology.objects.SA3_2021_AUST_GDA2020);
    const melb = { type:"FeatureCollection", features: geo.features.filter(f => f.properties.GCC_NAME21 === "Greater Melbourne") };
    const projection = d3.geoMercator().fitSize([width,height], melb);
    const path = d3.geoPath(projection);

    gBase.append("g")
      .selectAll("path").data(melb.features).join("path")
      .attr("d", path)
      .attr("fill", "#eef2ff")
      .attr("stroke", "#94a3b8")
      .attr("stroke-width", 0.6);

    // Detect lon/lat presence
    const hasLon = rawData.length && ("lon" in rawData[0]);
    const hasLat = rawData.length && ("lat" in rawData[0]);

    // Tidy table
    let data = rawData.map(d => ({
      Area: d.Area,
      area_norm: normName(d.Area),
      mode: normMode(d.mode ?? d.Mode ?? d.data_label ?? d["Data label"]),
      share_2016: toNum(d.share_2016 ?? d["2016%"] ?? d["2016 %"]),
      share_2021: toNum(d.share_2021 ?? d["2021%"] ?? d["2021 %"]),
      delta_pp: toNum(d.delta_pp ?? (toNum(d["2021%"])-toNum(d["2016%"]))),
      lon: hasLon ? +d.lon : NaN,
      lat: hasLat ? +d.lat : NaN
    }));

    // Join lon/lat if missing
    if (!hasLon || !hasLat) {
      const centByArea = new Map(centroids.map(c => [normName(c.Area), {lon:+c.lon, lat:+c.lat}]));
      data.forEach(d => {
        const c = centByArea.get(d.area_norm);
        if (c) { d.lon = c.lon; d.lat = c.lat; }
      });
      document.getElementById("joinNote").style.display = "block";
    }

    // Mode list
    const modes = Array.from(new Set(data.map(d => d.mode))).filter(Boolean).sort((a,b)=>a.localeCompare(b));
    const modeSel = document.getElementById("modeSel");
    modes.forEach(m => modeSel.appendChild(new Option(m, m)));

    // Controls
    const y2016 = document.getElementById("y2016");
    const y2021 = document.getElementById("y2021");
    function setYear(y){ y2016.classList.toggle("active", y===2016); y2021.classList.toggle("active", y===2021); render(modeSel.value, y); }
    modeSel.addEventListener("change", () => setYear(y2016.classList.contains("active") ? 2016 : 2021));
    y2016.addEventListener("click", () => setYear(2016));
    y2021.addEventListener("click", () => setYear(2021));

    // Render with tiny force-collision (declutters CBD)
    function render(mode, year){
      const rows = data.filter(d => d.mode === mode);

      const pts = rows.map(d => {
        const value = year === 2016 ? d.share_2016 : d.share_2021;
        const hasValue = Number.isFinite(value);
        const hasCoord = Number.isFinite(d.lon) && Number.isFinite(d.lat);
        const p = hasCoord ? projection([d.lon, d.lat]) : null;
        return { Area: d.Area, x0: p? p[0]:undefined, y0: p? p[1]:undefined, value, hasValue, mode, year };
      }).filter(d => d.x0 !== undefined);

      const vMax = d3.max(pts.filter(d => d.hasValue), d => d.value) || 10;
      const r = d3.scaleSqrt().domain([0, vMax]).range([2, 10]);

      const nodes = pts.map(d => ({ ...d, x: d.x0, y: d.y0 }));
      const sim = d3.forceSimulation(nodes)
        .force("x", d3.forceX(d => d.x0).strength(0.20))
        .force("y", d3.forceY(d => d.y0).strength(0.20))
        .force("collide", d3.forceCollide(d => r(d.hasValue ? d.value : 0.1) + 1.5))
        .stop();
      for (let i = 0; i < 120; i++) sim.tick();

      const circles = gDots.selectAll("circle").data(nodes, d => d.Area + "__" + mode);
      circles.join(
        enter => enter.append("circle")
          .attr("cx", d => d.x0).attr("cy", d => d.y0).attr("r", 0)
          .attr("fill", d => d.hasValue ? "#0284c7" : "#cbd5e1")
          .attr("fill-opacity", d => d.hasValue ? 0.75 : 0.9)
          .attr("stroke", d => d.hasValue ? "#0c4a6e" : "#94a3b8")
          .attr("stroke-width", 0.8)
          .on("mousemove", (e,d) => {
            const txt = d.hasValue ? `${d.mode} ${d.year}: ${d.value.toFixed(1)}%` : `No data for ${d.mode} ${d.year}`;
            tip.style("opacity",1).html(`<strong>${d.Area}</strong><br>${txt}`)
               .style("left",(e.pageX+12)+"px").style("top",(e.pageY-28)+"px");
          })
          .on("mouseleave", () => tip.style("opacity",0))
          .transition().duration(400)
          .attr("cx", d => d.x).attr("cy", d => d.y).attr("r", d => r(d.hasValue ? d.value : 0.1)),
        update => update.transition().duration(300)
          .attr("cx", d => d.x).attr("cy", d => d.y).attr("r", d => r(d.hasValue ? d.value : 0.1))
          .attr("fill", d => d.hasValue ? "#0284c7" : "#cbd5e1")
          .attr("stroke", d => d.hasValue ? "#0c4a6e" : "#94a3b8"),
        exit => exit.transition().duration(200).attr("r",0).remove()
      );

      const missing = nodes.filter(d => !d.hasValue).length;
      console.log(`Mode=${mode} Year=${year}: ${nodes.length - missing} dots with data; ${missing} grey.`);
    }

    setYear(2021);
  })();
  </script>
</body>
</html>
